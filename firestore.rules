rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // SUPER ADMIN CHECK
    function isSuperAdmin() {
      return request.auth.token.email == "akmusajee53@gmail.com";
    }

    // Get the user's Org ID from their User Document (works for Standard and Shadow users)
    function getOrgId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId;
    }

    // Check if the Resource (doc) belongs to the same Org as the Requestor
    function belongsToMyOrg() {
      return isAuthenticated() && 
             (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // Check if new doc is being created in the user's Org
    function createsInMyOrg() {
      return isAuthenticated() && 
             (request.resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    function isAdmin() {
      return isSuperAdmin() || (isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
    }

    // --- Rules ---

    // 1. USERS Collection
    match /users/{userId} {
      // READ
      allow read: if (isAuthenticated() && (
        resource.data.uid == request.auth.uid || 
        request.auth.uid == userId ||
        resource.data.orgId == getOrgId() ||
        isSuperAdmin()
      )) || (
        (!isAuthenticated() || request.auth.token.firebase.sign_in_provider == 'anonymous') && 
        request.query.limit <= 1
      );
      
      // CREATE
      allow create: if isAuthenticated() || (
        request.auth.token.firebase.sign_in_provider == 'anonymous' &&
        request.resource.data.isShadow == true &&
        request.resource.data.uid == request.auth.uid
      ); 
      
      // UPDATE
      allow update: if 
        isSuperAdmin() ||
        (isAdmin() && resource.data.orgId == getOrgId()) ||
        // Self Update: Allow update if NOT changing role or orgId
        (isAuthenticated() && request.auth.uid == resource.data.uid && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'orgId'])) ||
        // OTP Request
        (!isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['loginOTP', 'loginOTPExpires'])
        ) ||
        // OTP Verify Link
        (isAuthenticated() && request.auth.token.firebase.sign_in_provider == 'anonymous' &&
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid', 'loginOTP', 'loginOTPExpires'])
        );
      
      // DELETE
      allow delete: if (isAdmin() && resource.data.orgId == getOrgId()) || isSuperAdmin();
    }

    // 2. LEAVE REQUESTS
    match /leaveRequests/{requestId} {
      allow read: if belongsToMyOrg();
      allow create: if createsInMyOrg();
      
      // Update: Admin (Approval) OR User (Cancel own request)
      allow update: if isAuthenticated() && (
         (isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin())) || 
         (resource.data.userId == request.auth.uid && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'cancelledAt']) &&
          request.resource.data.status == 'Cancelled'
         )
      );

      allow delete: if isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // 3. ORGANIZATIONS
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && (orgId == getOrgId() || resource.data.ownerId == request.auth.uid || isSuperAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if (isAdmin() && orgId == getOrgId()) || isSuperAdmin();
    }

    // 4. PUBLIC HOLIDAYS
    match /publicHolidays/{holidayId} {
      allow read: if belongsToMyOrg();
      allow create: if createsInMyOrg(); 
      allow update, delete: if isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // 5. NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read: if belongsToMyOrg();
      allow create: if createsInMyOrg();
      allow update, delete: if isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // 6. INVITATIONS
    match /invitations/{inviteId} {
       allow read: if true; 
       allow create: if isAdmin() && createsInMyOrg();
       allow update: if true; 
    }
  }
}
