rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // SUPER ADMIN CHECK
    function isSuperAdmin() {
      return request.auth.token.email == "akmusajee53@gmail.com";
    }

    // Get the user's Org ID from their User Document (works for Standard and Shadow users)
    function getOrgId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.orgId;
    }

    // Check if the Resource (doc) belongs to the same Org as the Requestor
    function belongsToMyOrg() {
      return isAuthenticated() && 
             (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // Check if new doc is being created in the user's Org
    function createsInMyOrg() {
      return isAuthenticated() && 
             (request.resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    function isAdmin() {
      return isSuperAdmin() || (isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin");
    }

    // --- Rules ---

    // 1. USERS Collection
    match /users/{userId} {
      // READ: 
      // 1. Authenticated users can read their own data
      // 2. Organization members can read data from their org (Team View)
      // 3. Super Admin can read everything
      // 4. Unauthenticated/Anon users can QUERY by email (limit 1) to find account for login
      allow read: if (isAuthenticated() && (
        resource.data.uid == request.auth.uid || 
        request.auth.uid == userId ||
        resource.data.orgId == getOrgId() ||
        isSuperAdmin()
      )) || (
        (!isAuthenticated() || request.auth.token.firebase.sign_in_provider == 'anonymous') && 
        request.query.limit <= 1
      );
      
      // CREATE: 
      // 1. Signup (Standard Auth)
      // 2. Shadow Doc creation (Anonymous Auth, isShadow=true, matches UID)
      allow create: if isAuthenticated() || (
        request.auth.token.firebase.sign_in_provider == 'anonymous' &&
        request.resource.data.isShadow == true &&
        request.resource.data.uid == request.auth.uid
      ); 
      
      // UPDATE: 
      allow update: if 
        // Case 1: Super Admin
        isSuperAdmin() ||
        // Case 2: Org Admin (Managing users in same org)
        (isAdmin() && resource.data.orgId == getOrgId()) ||
        // Case 3: Self Update (Standard OR Shadow User updating their own doc)
        // Removed 'email != null' check to allow Shadow Users to update themselves
        (isAuthenticated() && request.auth.uid == resource.data.uid) ||
        // Case 4: OTP Request (Unauthenticated - sets OTP code on ANY user doc via email lookup)
        (!isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['loginOTP', 'loginOTPExpires'])
        ) ||
        // Case 5: OTP Verify Link (Anonymous User linking their UID to existing Account)
        // Here, auth.uid (Anon) DOES NOT match resource.uid (Old), so we need this explicit rule.
        (isAuthenticated() && request.auth.token.firebase.sign_in_provider == 'anonymous' &&
         request.resource.data.diff(resource.data).affectedKeys().hasAny(['uid', 'loginOTP', 'loginOTPExpires'])
        );
      
      // DELETE: Admin (same org) or Super Admin
      allow delete: if (isAdmin() && resource.data.orgId == getOrgId()) || isSuperAdmin();
    }

    // 2. LEAVE REQUESTS
    match /leaveRequests/{requestId} {
      allow read: if belongsToMyOrg();
      allow create: if createsInMyOrg();
      
      // Update: Admin (Approval) OR User (Cancel own request)
      allow update: if isAuthenticated() && (
         (isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin())) || 
         (resource.data.userId == request.auth.uid)
      );

      allow delete: if isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // 3. ORGANIZATIONS
    match /organizations/{orgId} {
      // Read: Member of Org OR Super Admin
      allow read: if isAuthenticated() && (orgId == getOrgId() || isSuperAdmin());
      
      // Create: Open for new Signups
      allow create: if isAuthenticated();
      
      // Update: Admin of that Org
      allow update, delete: if isAdmin() && (orgId == getOrgId() || isSuperAdmin());
    }

    // 4. PUBLIC HOLIDAYS
    match /publicHolidays/{holidayId} {
      allow read: if belongsToMyOrg();
      allow create: if createsInMyOrg(); 
      allow update, delete: if isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // 5. NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read: if belongsToMyOrg();
      allow create: if createsInMyOrg();
      allow update, delete: if isAdmin() && (resource.data.orgId == getOrgId() || isSuperAdmin());
    }

    // 6. INVITATIONS
    match /invitations/{inviteId} {
       allow read: if true; // Open read for verifying invite codes
       allow create: if isAdmin() && createsInMyOrg();
       allow update: if true; // Allow claiming invites (status updates)
    }
  }
}
